
<div id="map"></div>
<div class="text-center">
  <button class="btn" style="background: #31fc03"></button> - 30-60 дБ,
  <button class="btn" style="background: #fce803"></button> - 61-90 дБ,
  <button class="btn" style="background: #fc0320"></button> - более 90 дБ
</div>
<div class="text-center">
  <%= link_to 'Добавить точку', add_path, class: 'btn btn-success mt-3', style: 'border-radius: 18px; width: 80%' %>
  <%= link_to 'Все точки', points_path, class: 'btn btn-secondary mt-3', style: 'border-radius: 18px; width: 80%' %>
  <%= link_to 'Экспорт csv', get_csv_path, class: 'btn btn-secondary mt-3', style: 'border-radius: 18px; width: 80%' %>
</div>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBm2rSuphVK9QJyiyPkd4LN1SQj7yeMnw0&region=RU&&libraries=places"></script>
<style>
    #map {
        height: 600px;
        width: 100%;
    }
</style>
<script>

    var map, infoWindow;
    var pos;
    var marker;
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: -34.397, lng: 150.644 },
            zoom: 19,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "all",
                    "stylers": [
                        {
                            "invert_lightness": true
                        },
                        {
                            "saturation": "-9"
                        },
                        {
                            "lightness": "0"
                        },
                        {
                            "visibility": "simplified"
                        }
                    ]
                },
                {
                    "featureType": "landscape.man_made",
                    "elementType": "all",
                    "stylers": [
                        {
                            "weight": "1.00"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "all",
                    "stylers": [
                        {
                            "weight": "0.49"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels",
                    "stylers": [
                        {
                            "visibility": "on"
                        },
                        {
                            "weight": "0.01"
                        },
                        {
                            "lightness": "-7"
                        },
                        {
                            "saturation": "-35"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels.text",
                    "stylers": [
                        {
                            "visibility": "on"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels.text.stroke",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "on"
                        }
                    ]
                }
            ]
        });
        setMarkers();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    map.setCenter(pos);
                    pos = new google.maps.LatLng(pos.lat, pos.lng);
                },
                () => {
                    handleLocationError(true, infoWindow, map.getCenter());
                }
            );
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
        }

    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
                ? "Error: The Geolocation service failed."
                : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
    }

    initMap();

    function setMarkers() {
        var infowindow = new google.maps.InfoWindow({
            size: new google.maps.Size(150, 50)
        });
        <% @points.each do |point| %>
          marker<%= point.id %> = new google.maps.Marker(
              {
                  map: map,
                  position: {lat: <%= point.lat %>, lng: <%= point.lon %>},
                  icon: {
                      path: google.maps.SymbolPath.CIRCLE,
                      fillColor: '<%= get_color(point) %>',
                      fillOpacity: 0.6,
                      strokeColor: '#000',
                      strokeWeight: 1,
                      scale: 8,
                  }
              });
        marker<%= point.id %>.addListener('click', function(event) {
            infowindow.setContent("<h3><%= point.decibel %> дБ</h3>");
            infowindow.setPosition(event.latLng);
            infowindow.open(map);
        });
        <% end %>

    }




</script>